name: Build and Publish to Public Release Repo

on:
  push:
    tags:
      - 'v*'

jobs:
  create_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      GH_TAG: ${{ github.ref_name }}
      GH_TOKEN: ${{ secrets.RELEASE_PUSH_TOKEN }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Extract release notes from CHANGELOG.md
        id: notes
        run: |
          VERSION="${GH_TAG#v}"
          # Extract the section for this version (from "## [X.Y.Z]" up to, but not including, the next "## [")
          awk -v ver="$VERSION" '
            index($0, "## [" ver "]") == 1 { found = 1 }
            found && /^## \[/ && index($0, "## [" ver "]") != 1 { exit }
            found { print }
          ' CHANGELOG.md > release_notes.md
          # If we found a section, use it; otherwise fall back to empty (workflow will still create release)
          if [ -s release_notes.md ]; then
            echo "path=release_notes.md" >> "$GITHUB_OUTPUT"
            echo "has_notes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_notes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update GitHub release with changelog notes
        run: |
          if gh release view "$GH_TAG" --repo "${{ github.repository }}" 2>/dev/null; then
            if [ "${{ steps.notes.outputs.has_notes }}" = "true" ]; then
              gh release edit "$GH_TAG" --repo "${{ github.repository }}" --notes-file release_notes.md
            fi
          else
            if [ "${{ steps.notes.outputs.has_notes }}" = "true" ]; then
              gh release create "$GH_TAG" --repo "${{ github.repository }}" --title "$GH_TAG" --notes-file release_notes.md
            else
              gh release create "$GH_TAG" --repo "${{ github.repository }}" --title "$GH_TAG" --generate-notes
            fi
          fi

  build:
    needs: create_release
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        include:
          - os: windows-latest
            platform: win
          - os: macos-latest
            platform: mac
          - os: ubuntu-latest
            platform: linux
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    env:
      GH_TAG: ${{ github.ref_name }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build:ci

      - name: Build and publish with electron-builder
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PUSH_TOKEN }}
        run: |
          npx electron-builder --${{ matrix.platform }} --publish always
